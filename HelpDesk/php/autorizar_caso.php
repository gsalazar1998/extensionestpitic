<?php require_once("MySQL/ErrorManager.class.php");require_once("MySQL/MySQL.class.php");require_once("phpmailer/class.phpmailer.php");require_once("funciones_generales.php");$id_caso = $_GET['idcaso'];$codigo = $_GET['cod'];$uid = $_GET['uid'];$aut = $_GET['aut'];function autorizar($id_caso, $codigo, $uid, $autorizacion, $comentario){	$mysql = new MySQL();	$mysql->connect(); 	$query = "SELECT * FROM casos_autorizaciones WHERE ID_SOLICITUD = '".$codigo."' AND ID_CASO = '".$id_caso."' AND AUTORIZADO_POR = '".$uid."'";	$result = $mysql->query($query);	$numero = mysql_num_rows($result);	if($numero == 1){		$row = mysql_fetch_array($result);		if($autorizacion == 1){			$query = "UPDATE casos SET AUTORIZADO_POR = '".$row['AUTORIZADO_POR']."', ESTADO_AUTORIZACION='AUTORIZADO' WHERE ID_CASO = ".$row['ID_CASO'];			$query_autorizacion = "UPDATE casos_autorizaciones SET FECHA_AUTORIZACION = NOW() WHERE ID_SOLICITUD = '".$codigo."'";			$aut_title = "AUTORIZACION APROBADA ";			$autoriza = "AUTORIZADO";			$val = 1; //valor bandera AUTORIZADO		}		if($autorizacion == 0){			$query = "UPDATE casos SET AUTORIZADO_POR = '".$row['AUTORIZADO_POR']."', ESTADO_AUTORIZACION='RECHAZADO' WHERE ID_CASO = ".$row['ID_CASO'];			$query_autorizacion = "UPDATE casos_autorizaciones SET FECHA_AUTORIZACION = NOW() WHERE ID_SOLICITUD = '".$codigo."'";			$aut_title = "AUTORIZACION RECHAZADA ";			$autoriza = "RECHAZADO LA AUTORIZACION para";			$val = 2; //valor bandera RECHAZADO						$queryComment = "INSERT INTO casos_respuestas VALUES ('".$id_caso."', '".$uid."', '".$comentario."',  NOW())";			$resultComment = $mysql->query($queryComment);		}		$result = $mysql->query($query);				 $mysql->query($query_autorizacion);		if($result){			enviarMail($id_caso, $uid, $aut_title, $autoriza);			if($val == 2){				//vamos a obtener los archivos que este caso tiene dados de alta				$mysql->connect(); 				$q = "SELECT ARCHIVOS FROM casos WHERE ID_CASO = ".$id_caso;				$rs = $mysql->query($q);				$row = mysql_fetch_array($rs);				//creamos objeto de la clase Funciones generales y accedemos a la funcion borrar archivos				//pasandole como parametro la cadena con los archivos que tiene registrados este caso				$objFN = new FuncionesGrales();				$objFN->borrarArchivos($row['ARCHIVOS']);				//borramos el registro de los archivos en la base de datos "ejmplo.jpg,asd.doc,etc.ppt"				$qry = "UPDATE casos SET ARCHIVOS = NULL WHERE ID_CASO = ".$id_caso;				$rs = $mysql->query($qry);			}			return $val;		}	}else{		return 3;	}}function verificarAutorizado($id_caso){	$mysql = new MySQL();	$mysql->connect(); 	$query = "SELECT ESTADO_CASO, AUTORIZADO_POR, ESTADO_AUTORIZACION FROM casos WHERE ID_CASO = ".$id_caso;	$result = $mysql->query($query);	$numero = mysql_num_rows($result);	$row = mysql_fetch_array($result);	if($row['AUTORIZADO_POR'] != NULL && $row['ESTADO_AUTORIZACION'] == "AUTORIZADO"){		return "AUTORIZADO";	}	elseif($row['AUTORIZADO_POR'] != NULL && $row['ESTADO_AUTORIZACION'] == "RECHAZADO"){		return "RECHAZADO";	}	elseif($row['ESTADO_CASO'] == 0 || $row['ESTADO_CASO'] == 3){		return "CERRADO";	}	else{		return "ESPERANDO";	}}function enviarMail($id_caso, $uid, $aut_title, $autorizacion){	$mail = new phpmailer();	$mail->PluginDir = "";	$mail->Mailer = "smtp";	$mail->Host = "smtp.tpitic.com.mx";	$mail->SMTPAuth = true;	$mysql = new MySQL();	$mysql->connect(); 	$query = "SELECT * FROM casos WHERE ID_CASO = ".$id_caso;	$result = $mysql->query($query);	$row = mysql_fetch_array($result);		//Le decimos cual es nuestro nombre de usuario y password	$mail->Username = "helpdesk@tpitic.com.mx"; 	$mail->Password = "wj6n0twsp";	//Indicamos cual es nuestra dirección de correo y el nombre que 	//queremos que vea el usuario que lee nuestro correo	$mail->From = "sistemas@tpitic.com.mx";	$mail->FromName = "HelpDesk del Departamento de Sistemas";	//el valor por defecto 10 de Timeout es un poco escaso dado que voy a usar 	//una cuenta gratuita, por tanto lo pongo a 30  	$mail->Timeout=30;	//Indicamos cual es la dirección de destino del correo	$mail->AddAddress($row['USUARIO']."@tpitic.com.mx");	$mail->AddAddress($row['ASIGNADO_A']."@tpitic.com.mx");	$mail->AddAddress("acota@tpitic.com.mx"); //CORREO ALEX	//$mail->AddAddress("cmburboa@tpitic.com.mx"); //CORREO ALEX	//Asignamos asunto y cuerpo del mensaje	//El cuerpo del mensaje lo ponemos en formato html, haciendo 	//que se vea en negrita	$mail->Subject = $aut_title."para el caso ".$id_caso;	$mail->Body = "<strong><span style='color:red;'>".$uid."</span></strong> ha ".$autorizacion." el caso No <span style='color:red;'><strong>".$id_caso."</strong>&nbsp;&nbsp;<a href='http://sistemas.tpitic.com.mx/HelpDesk/php/mostrar_caso_detalles.php?idcaso=".$id_caso."'>Ver detalles</a></span>";	//Definimos AltBody por si el destinatario del correo no admite email con formato html 	$mail->AltBody = "Por favor utilize un lector de correo que soporte HTML";	$exito = $mail->Send();	if(!$exito){		$errores .= "<pre>Problemas enviando correo electrónico a ".$usuario."<br />";		$errores .= $mail->ErrorInfo ."</pre>";		}else{	} }$bandera = 0;if(verificarAutorizado($id_caso)=="ESPERANDO"){	switch($aut){		case 1: 			if(autorizar($id_caso, $codigo, $uid, $aut, '') == 1){//AUTORIZARA EL CASO				$bandera = 1;			}elseif(autorizar($id_caso, $codigo, $uid, 2, '') == 3){//LLAVE INCORRECTA (se envia el valor '2' nomas porque lo pide el metodo pero podria ser cualquier numero)				$bandera = 3;			}else{				$bandera = 4;			} break;		case 0:			if(!isset($_GET['comentario'])){				/*echo "				<form id='rechazado' name='rechazado' method='GET'/>					<input type='hidden' name='idcaso' value='".$id_caso."' />					<input type='hidden' value='".$codigo."' name='cod' />					<input type='hidden' value='".$uid."' name='uid' />					<input type='hidden' value='".$aut."' name='aut' />					<textarea id='comentario' name='comentario'></textarea><br />					<input type='submit' value='Grabar' />				</form>				";*/			}			if(isset($_GET['comentario']) && $_GET['comentario'] != ""){				if(autorizar($id_caso, $codigo, $uid, $aut, $_GET['comentario']) == 2){//RECHAZA EL CASO					$bandera = 2;				}elseif(autorizar($id_caso, $codigo, $uid, 2, $_GET['comentario']) == 3){//LLAVE INCORRECTA (se envia el valor '2' nomas porque lo pide el metodo pero podria ser cualquier numero)					$bandera = 3;				}else{					$bandera = 4;				}			}else{				echo "<script>alert('Por favor escriba un comentario del porque rechaza este caso.')</script>";				echo "				<center><form id='rechazado' name='rechazado' method='GET'/>					<input type='hidden' name='idcaso' value='".$id_caso."' />					<input type='hidden' value='".$codigo."' name='cod' />					<input type='hidden' value='".$uid."' name='uid' />					<input type='hidden' value='".$aut."' name='aut' />					Escriba aqu&iacute; su comentario:<br />					<textarea id='comentario' name='comentario'></textarea><br />					<input type='submit' value='Grabar' />				</form></center>				";			} break;	}}elseif(verificarAutorizado($id_caso)=="RECHAZADO"){	$bandera = 6;}elseif(verificarAutorizado($id_caso)=="CERRADO"){	$bandera = 7;}else{	if(autorizar($id_caso, $codigo, $uid, $aut, '') == 3){		$bandera = 3;	}else{		$bandera = 5;	}}?><!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"><html>	<head>		<meta http-equiv="content-type" content="text/html; charset=utf-8" />				<title>Caso Autorizado</title>		<!--JQuery y JQueryUI -->		<link type="text/css" href="../js/jqueryui/css/custom-theme/jquery-ui-1.8.11.custom.css" rel="stylesheet" />			<script type="text/javascript" src="../js/jqueryui/js/jquery-1.5.1.min.js"></script>		<script type="text/javascript" src="../js/jqueryui/js/jquery-ui-1.8.11.custom.min.js"></script>		<script>		$(function() {			$('#msgDialog').dialog({				autoOpen: false,				width: 400,				draggable: true,				resizeable: false,				buttons:{					'Aceptar': function(){						$(this).dialog('close');					}				},			});		<?php			$mysql = new MySQL();			$mysql->connect(); 			$query = "SELECT AUTORIZADO_POR FROM casos WHERE ID_CASO = ".$id_caso;			$result = $mysql->query($query);			$row = mysql_fetch_array($result);			switch($bandera){				case 1: echo "$('#msgDialog').html('Gracias por su autorizaci&oacuten<br><br>');					$('#msgDialog').dialog('open');"; break;				case 2: echo "$('#msgDialog').html('Gracias, Usted ha RECHAZADO la autorizacion de este caso');					$('#msgDialog').dialog('open');"; break;				case 3: echo "$('#msgDialog').html('Llave incorrecta');					$('#msgDialog').dialog('open');"; break;				case 4: echo "$('#msgDialog').html('Error Desconocido');					$('#msgDialog').dialog('open');"; break;				case 5: echo "$('#msgDialog').html('Gracias, pero el caso ya ha sido autorizado por ".$row['AUTORIZADO_POR']."');					$('#msgDialog').dialog('open');"; break;				case 6: echo "$('#msgDialog').html('Gracias, pero ".$row['AUTORIZADO_POR']." ya ha RECHAZADO la autorizaci&oacuten de este caso');					$('#msgDialog').dialog('open');"; break;				case 7: echo "$('#msgDialog').html('El caso que usted esta tratando de autorizar ya se encuentra cerrado.');					$('#msgDialog').dialog('open');"; break;			}		?>		});	</script>	<style type="text/css" title="currentStyle">					.fuente{ font: 70.5% "Trebuchet MS", sans-serif; margin: 5px;}			.demoHeaders { margin-top: 2em; }			.sombras {				background:#f9f9f9;				border: solid 1px #CCC;				padding:4px 2px;				font-family: 'Lucida Grande',Tahoma,Arial,Verdana,Sans-Serif; 				color:#333;				font-size:12px;				-moz-border-radius: 3px;				-khtml-border-radius: 3px;				-webkit-border-radius: 3px;				box-shadow:inset 2px 2px 2px #CCC;				-moz-box-shadow:inset 2px 2px 2px #CCC;				-webkit-box-shadow:inset 2px 2px 2px #CCC;			}		</style>	</head>	<body class='fuente'>	<div id="msgDialog" title="Autorizacion de casos"></div><!--Ventana de Dialogos -->	</body></html>