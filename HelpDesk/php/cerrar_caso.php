<?phprequire_once("MySQL/ErrorManager.class.php");require_once("MySQL/MySQL.class.php");require_once("phpmailer/class.phpmailer.php");require_once("funciones_generales.php");session_start();function cerrarSinConfirmacion($oficina, $id_caso, $finalComment){	$mysql = new MySQL();	$mysql->connect();	$objFN = new FuncionesGrales();	$qry = "SELECT verificaVencimientoCasos(".$id_caso.") AS T_RESOLUCION";	$rs = $mysql->query($qry) or die(mysql_error());	$renglon = mysql_fetch_array($rs);		if($renglon['T_RESOLUCION'] == 1){		$vencido = 1;	}else{		$vencido = 0;	}		$qry2 = "SELECT FEC_INICIO_REVISION FROM casos WHERE ID_CASO = '".$id_caso."'";	$rs = $mysql->query($qry2) or die(mysql_error());	$ren = mysql_fetch_array($rs);	if($ren['FEC_INICIO_REVISION'] != null){		$query = "UPDATE casos SET OFICINA = '".$oficina."', FECHA_CIERRE = NOW(), TIEMPO_VENCIDO = '".$vencido."',ESTADO_CASO = '2' WHERE ID_CASO = ".$id_caso;		$result = $mysql->query($query);				if($finalComment != "vacio"){			$q = "INSERT INTO casos_respuestas VALUES(".$id_caso.",'".$_SESSION['usuario']."','".$finalComment."',NOW())";			$rs = $mysql->query($q);		}		if($result){			enviarMail($id_caso, $finalComment);			return true;		}else{			return false;		}	}else{		echo "NO SE HA MARCADO EL CASO PARA REVISION";	}}function enviarMail($idCaso, $finalComment){	$mail = new phpmailer();	$mail->PluginDir = "";	$mail->Mailer = "smtp";	$mail->Host = "smtp.gmail.com";	$mail->SMTPSecure = "ssl";	$mail->SMTPAuth = true;	$mail->Port = 465;	$mysql = new MySQL();	$mysql->connect();	$query = "SELECT * FROM casos WHERE ID_CASO = '".$idCaso."'";	$result = $mysql->query($query);	$numero = mysql_num_rows($result);	$row = mysql_fetch_array($result);		//Le decimos cual es nuestro nombre de usuario y password	$mail->Username = "helpdesk@tpitic.com.mx"; 	$mail->Password = "tp1t1c123";	//Indicamos cual es nuestra dirección de correo y el nombre que 	//queremos que vea el usuario que lee nuestro correo	$mail->From = "sistemas@tpitic.com.mx";	$mail->FromName = "HelpDesk del Departamento de Sistemas";	//el valor por defecto 10 de Timeout es un poco escaso dado que voy a usar 	//una cuenta gratuita, por tanto lo pongo a 30  	$mail->Timeout=30;	//Indicamos cual es la dirección de destino del correo	$mail->AddAddress($row['USUARIO']."@tpitic.com.mx");	//$mail->AddAddress("acota@tpitic.com.mx"); //CORREO ALEX	//$mail->AddAddress("cmburboa@tpitic.com.mx"); //CORREO MISA	//Asignamos asunto y cuerpo del mensaje	//El cuerpo del mensaje lo ponemos en formato html, haciendo 	//que se vea en negrita	$mail->Subject = $row['ASIGNADO_A']." ha cerrado el caso No.".$idCaso." \"".$row['PROBLEMA']."\"";	if($finalComment != "vacio"){		$comentarioFinal = $finalComment;	}else{		$comentarioFinal = "";	}	$mail->Body = "	<style>	body{		font-family: Tahoma, Verdana, Arial;		font-size: 15px;	}	table {		font-family: Tahoma, Verdana, Arial;		font-size: 15px;		border-top: 1px solid black;		border-bottom: 1px solid black;		border-left: 1px solid black;		border-right: 1px solid black;	}	#resp{		border:dashed black 1px;		background-color:#E6E6E6;		padding:15px;	}	</style>	<div id='resp'>".$comentarioFinal."</div><br />Esos fueron los comentarios finales del cierre de caso<br /><br /><span style='color:red'>Para verificar y cerrar completamente el caso o reabrirlo de click <a href='http://sistemas.tpitic.com.mx/HelpDesk/php/ver_cierra_caso.php?idcaso=".$idCaso."&usuario=".$row['USUARIO']."'>Aqu&iacute;</a><br /><br /></span>";	//Definimos AltBody por si el destinatario del correo no admite email con formato html 	$mail->AltBody = "Por favor utilize un lector de correo que soporte HTML";	$exito = $mail->Send();	if(!$exito){		echo "<pre>Problemas enviando correo electr&oacutenico a ".$usuario."<br />";		echo $mail->ErrorInfo ."</pre>";		}else{	} }$finalComment = isset($_POST['finalComment']) ? addslashes($_POST['finalComment']) : "NO";if($finalComment == "" || $finalComment == null || $finalComment == "undefinded"){	$finalComment == "vacio";}if(cerrarSinConfirmacion($_POST['oficina'], $_POST['idcaso'], $finalComment)){ //dice sin confirmacion porque falta la confirmacion del usuario que abrio el caso	echo "OK";}else{	echo "<br />HUBO UN ERROR AL GRABAR EN LA BASE DE DATOS";}?>